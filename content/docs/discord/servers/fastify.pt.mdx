---
title: Fastify
icon: SiFastify
---
import icons from "@/icons";

A predefini√ß√£o de servidor de API usando fastify j√° vem com algumas configura√ß√µes para facilitar o desenvolvimento. Veja abaixo o que voc√™ precisa saber para utilizar:

<Blockquote color="warn" icon={icons.warn}>
    √â necess√°rio conhecer o framework fastify para utilizar da melhor forma, leia a documenta√ß√£o: https://fastify.dev/
</Blockquote>

## Fun√ß√£o de entrada

Assim como na base do projeto temos a fun√ß√£o **boostrapApp** para carregar os m√≥dulos e iniciar o bot, temos tamb√©m a fun√ß√£o **boostrapServer** que fica no arquivo `src/server/index.ts`. Essa fun√ß√£o √© exportada para server chamada assim que o bot estiver pronto:

```ts title="src/index.ts"
import { bootstrapApp } from "#base";
import { bootstrapServer } from "#server";

await bootstrapApp({ 
    workdir: import.meta.dirname,
    whenReady: bootstrapServer
});
```

<Accordions>
  <Accordion title="Caso voc√™ queira executar outras coisas no m√©todo whenReady">
    ```ts title="src/index.ts"
    import { bootstrapApp } from "#base";
    import { bootstrapServer } from "#server";

    await bootstrapApp({ 
        workdir: import.meta.dirname,
        whenReady(client){
            // executar outras coisas
            bootstrapServer(client);
        }
    });
    ```
  </Accordion>
</Accordions>

Com isso o servidor fastify ir√° iniciar logo ap√≥s o bot ficar online, assim recebendo o Client como argumento.

## Vari√°veis de ambiente

O schema zod para validar o env √© alterado para permitir novas vari√°vies de ambiente

```ts title="src/settings/env.ts"
import { z } from "zod";

const envSchema = z.object({
    BOT_TOKEN: z.string({ description: "Discord Bot Token is required" }).min(1),
    WEBHOOK_LOGS_URL: z.string().url().optional(),
    SERVER_PORT: z.number({ coerce: true }).optional(), // [!code highlight]
    // Env vars...
});

type EnvSchema = z.infer<typeof envSchema>;

export { envSchema, type EnvSchema };
```

Isso significa que voc√™ pode alterar a **PORTA** do servidor fasitfy usando essa vari√°vel no arquivo `.env`

```properties title=".env"
BOT_TOKEN=yourtoken
SERVER_PORT=8080
```

## Carregamento e registro autom√°tico

Por padr√£o, esta predefini√ß√£o vem com o plugin `@fastify/autoload` instalado, com isso podemos configurar uma pasta com manipuladores de rotas que ser√£o definidos autom√°ticamente:

```ts title="src/server/index.ts"
import fastify, { type FastifyInstance } from "fastify";
import autoload from "@fastify/autoload";
import type { Client } from "discord.js";
import path from "node:path";
// ...

export async function bootstrapServer(client: Client<true>){
    // ...
    // [!code word:autoload]
    app.register(autoload, { // [!code highlight]
        dir: path.join(import.meta.dirname, "routes"), // [!code highlight]
        routeParams: true, // [!code highlight]
    // [!code word:client]
        options: client, // [!code highlight]
    }); // [!code highlight]
    // ...
}
```

Essa configura√ß√£o vai importar e registrar os manipuladores de rota de todos os arquivos da pasta `src/server/routes`.

<Blockquote color="warn" icon={icons.warn}>
  Por isso √© muito importante que todos os arquivos da pasta routes tenham uma exporta√ß√£o padr√£o de uma fun√ß√£o que recebe a inst√¢ncia do fastify, o client do discord e a fun√ß√£o done do fastify
</Blockquote>

Veja um exemplo da rota raiz retornando algumas informa√ß√µes:

```ts title="src/server/routes/home.ts"
import { defineRoutes } from "#server";
import { StatusCodes } from "http-status-codes";

export default defineRoutes((app, client) => {
    app.get("/", (_, res) => {
        return res.status(StatusCodes.OK).send({
            message: `üçÉ Online on discord as ${client.user.username}`,
            guilds: client.guilds.cache.size,
            users: client.users.cache.size
        });
    });
});
```

<Accordions>
  <Accordion title="Outras maneiras de definir as rotas">
    <Blockquote color="info" icon={icons.info}>
    No exemplo acima foi utilizado uma fun√ß√£o utilit√°ria que j√° vem na predefini√ß√£o, para definir as rotas, mas se voc√™ preferir pode apenas exportar uma fun√ß√£o tipando os par√¢metros corretamente
    </Blockquote>

    ```ts title="src/server/routes/home.ts"
    import type { FastifyInstance } from "fastify";
    import type { Client } from "discord.js";
    import { StatusCodes } from "http-status-codes";

    export default function homeRoute(app: FastifyInstance, client: Client<true>, done: Function){
        // ...
        // [!code word:done]
        done(); // [!code highlight]
    };
    ```
    <Blockquote color="warn" icon={icons.warn}>
    Caso for exportar dessa maneira n√£o esque√ßa de executar a fun√ß√£o done no final
    </Blockquote>

    Voc√™ pode usar o tipo exportado da predefini√ß√£o tamb√©m:

     ```ts title="src/server/routes/home.ts"
    import type { RouteHandler } from "#server";
    import { StatusCodes } from "http-status-codes";

    export default ((app, client, done) => {
        // ...
        done()
    }) satisfies RouteHandler
    ```
  </Accordion>
</Accordions>

O plugin `@fastify/autoload` importa m√≥dulos de subpastas e transforma o caminho em uma rota:

Crie um arquivo em `src/server/routes/users`:
```ts title="src/server/routes/users/route.ts"
import { defineRoutes } from "#server";
import { StatusCodes } from "http-status-codes";

export default defineRoutes((app, client) => {
    app.get("/", (_, res) => {
        return res.status(StatusCodes.OK).send({
            message: "Retorna todos os usu√°rios",
        });
    });

    app.get("/:id", (req, res) => {
        const { id } = req.params as { id: string };

        return res.status(StatusCodes.OK).send({
            message: "Retorna um usu√°rio pelo id",
        });
    });
});
```

No exemplo acima, ser√° registrado duas rotas, a primeira sendo `/users` e a segunda sendo `/users/:id`.
<Blockquote color="info" icon={icons.info}>
    Leia a documenta√ß√£o completa do plugin para entender os melhores casos de uso: https://github.com/fastify/fastify-autoload
</Blockquote>

## Cors

Nesta predefini√ß√£o, o plugin de cors j√° vem instalado e com uma configura√ß√£o b√°sica:

```ts title="src/server/index.ts"
import fastify, { type FastifyInstance } from "fastify";
import cors from "@fastify/cors";
import type { Client } from "discord.js";
import path from "node:path";
// ...

export async function bootstrapServer(client: Client<true>){
    // ...
    // [!code word:cors]
    app.register(cors, { origin: "*" }); // [!code highlight]
    // ...
}
```

<Blockquote color="info" icon={icons.info}>
    Leia a documenta√ß√£o completa do plugin para entender os melhores casos de uso: https://github.com/fastify/fastify-cors
</Blockquote>